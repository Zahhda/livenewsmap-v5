<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Users ‚Ä¢ Admin</title>
  <link rel="icon" type="image/png" href="/img/favicon.png" />
  <link rel="apple-touch-icon" href="/img/favicon.png" />
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <div class="topbar">
    <span style="font-weight:600">Admin Panel</span>
    <div id="adminTabs" style="display:inline-flex;gap:8px;margin-left:16px;">
      <a href="/admin" data-tab="regions" style="text-decoration:none;background:#0b0b0b;border:1px solid var(--border);padding:8px 10px;border-radius:10px;color:var(--muted)">Regions</a>
      <a href="/admin/users" data-tab="users" style="text-decoration:none;background:#111;border:1px solid var(--border);padding:8px 10px;border-radius:10px;color:inherit">Users</a>
    </div>
    <a href="/admin" style="text-decoration:none;color:inherit;font-weight:700">‚Üê Admin</a>
    <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
      <button id="addUserBtn" class="btn" style="padding:8px 12px;border:1px solid #333;border-radius:8px">Add User</button>
    </div>
  </div>
  <main style="max-width:1200px;margin:24px auto;padding:20px">
    <!-- Header Section -->
    <div style="margin-bottom:32px">
      <h1 style="font-size:28px;margin-bottom:8px;color:#fff;font-weight:700">User Management</h1>
      <p style="color:#888;margin:0;font-size:16px">Manage users and their region access permissions</p>
    </div>

    <!-- Tab Navigation -->
    <div style="margin-bottom:24px;border-bottom:1px solid #333">
      <div style="display:flex;gap:0">
        <button id="usersTab" class="tab-button active" style="padding:12px 24px;background:#111;border:none;border-bottom:2px solid #ff4d4d;color:#fff;cursor:pointer;font-size:14px;font-weight:600;transition:all 0.2s">
          Users
        </button>
        <button id="locationsTab" class="tab-button" style="padding:12px 24px;background:transparent;border:none;border-bottom:2px solid transparent;color:#888;cursor:pointer;font-size:14px;font-weight:600;transition:all 0.2s" onmouseover="this.style.color='#fff'" onmouseout="this.style.color='#888'">
          User Locations
        </button>
      </div>
    </div>

    <!-- Pending Requests Section -->
    <div id="pendingRequestsSection" style="margin-bottom:32px;display:none">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
        <div style="width:40px;height:40px;background:linear-gradient(135deg, #ff4d4d, #ff6b6b);border-radius:10px;display:flex;align-items:center;justify-content:center">
          <span style="font-size:18px;color:#fff">‚è≥</span>
        </div>
        <div>
          <h2 style="margin:0;font-size:20px;color:#fff;font-weight:600">Pending Region Access Requests</h2>
          <p style="margin:4px 0 0;color:#888;font-size:14px">Review and approve user access requests</p>
        </div>
      </div>
      <div id="pendingRequestsWrap" class="card" style="border:1px solid #ff4d4d;border-radius:16px;overflow:hidden;background:linear-gradient(135deg, #1a0f0f 0%, #2a1515 100%);box-shadow:0 8px 32px rgba(255,77,77,0.1)">
        <div id="pendingRequestsBody" style="padding:20px">
          <!-- Pending requests will be populated here -->
        </div>
      </div>
    </div>

    <!-- Users Tab Content -->
    <div id="usersTabContent">
      <!-- Users Table Section -->
      <div style="background:#0b0b0b;border:1px solid #333;border-radius:16px;overflow:hidden;box-shadow:0 8px 32px rgba(0,0,0,0.3)">
        <div style="padding:20px;border-bottom:1px solid #333;background:linear-gradient(135deg, #111 0%, #1a1a1a 100%)">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
            <div style="display:flex;align-items:center;gap:12px">
              <div style="width:40px;height:40px;background:linear-gradient(135deg, #4d79ff, #6b8cff);border-radius:10px;display:flex;align-items:center;justify-content:center">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: #fff">
                  <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                  <circle cx="9" cy="7" r="4"></circle>
                  <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                  <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
              </div>
              <div>
                <h3 style="margin:0;font-size:18px;color:#fff;font-weight:600">All Users</h3>
                <p style="margin:4px 0 0;color:#888;font-size:14px">Manage user accounts and permissions</p>
              </div>
            </div>
            <div style="display:flex;align-items:center;gap:12px">
              <div style="position:relative">
                <input type="text" id="userSearch" placeholder="Search users..." style="
                  padding:8px 12px 8px 36px;
                  background:#1a1a1a;
                  border:1px solid #333;
                  border-radius:8px;
                  color:#fff;
                  font-size:14px;
                  width:250px;
                  outline:none;
                  transition:border-color 0.2s;
                " onfocus="this.style.borderColor='#4d79ff'" onblur="this.style.borderColor='#333'">
                <div id="searchIcon" style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#888;font-size:14px">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                  </svg>
                </div>
              </div>
              <button id="clearSearch" style="
                padding:8px 12px;
                background:transparent;
                border:1px solid #333;
                border-radius:8px;
                color:#888;
                cursor:pointer;
                font-size:12px;
                transition:all 0.2s;
              " onmouseover="this.style.background='#333';this.style.color='#fff'" onmouseout="this.style.background='transparent';this.style.color='#888'">
                Clear
              </button>
            </div>
          </div>
        </div>
        
        <div id="usersWrap" style="overflow-x:auto">
      <table style="width:100%;border-collapse:collapse">
        <thead>
          <tr style="background:#111">
                <th style="text-align:left;padding:16px;border-bottom:1px solid #333;color:#fff;font-weight:600;font-size:14px;text-transform:uppercase;letter-spacing:0.5px">Name</th>
                <th style="text-align:left;padding:16px;border-bottom:1px solid #333;color:#fff;font-weight:600;font-size:14px;text-transform:uppercase;letter-spacing:0.5px">Email</th>
                <th style="text-align:left;padding:16px;border-bottom:1px solid #333;color:#fff;font-weight:600;font-size:14px;text-transform:uppercase;letter-spacing:0.5px">Phone</th>
                <th style="text-align:left;padding:16px;border-bottom:1px solid #333;color:#fff;font-weight:600;font-size:14px;text-transform:uppercase;letter-spacing:0.5px">Role</th>
                <th style="text-align:left;padding:16px;border-bottom:1px solid #333;color:#fff;font-weight:600;font-size:14px;text-transform:uppercase;letter-spacing:0.5px">Joined</th>
                <th style="text-align:left;padding:16px;border-bottom:1px solid #333;color:#fff;font-weight:600;font-size:14px;text-transform:uppercase;letter-spacing:0.5px">Actions</th>
          </tr>
        </thead>
        <tbody id="usersBody"></tbody>
      </table>
        </div>
      </div>
    </div>

    <!-- Locations Tab Content -->
    <div id="locationsTabContent" style="display:none">
      <!-- Locations Table Section -->
      <div style="background:#0b0b0b;border:1px solid #333;border-radius:16px;overflow:hidden;box-shadow:0 8px 32px rgba(0,0,0,0.3)">
        <div style="padding:20px;border-bottom:1px solid #333;background:linear-gradient(135deg, #111 0%, #1a1a1a 100%)">
          <div style="display:flex;align-items:center;justify-content:between">
            <div style="display:flex;align-items:center;gap:12px">
              <div style="width:40px;height:40px;background:linear-gradient(135deg, #ff4d4d, #ff6b6b);border-radius:10px;display:flex;align-items:center;justify-content:center">
                <span style="font-size:18px;color:#fff">üìç</span>
              </div>
              <div>
                <h3 style="margin:0;font-size:18px;color:#fff;font-weight:600">User Locations</h3>
                <p style="margin:4px 0 0;color:#888;font-size:14px">View and manage user location data</p>
              </div>
            </div>
            <button id="refreshLocationsBtn" style="padding:8px 16px;background:linear-gradient(135deg, #4d79ff, #6b8cff);border:none;border-radius:8px;color:#fff;cursor:pointer;font-size:14px;font-weight:600;transition:all 0.2s" onmouseover="this.style.transform='translateY(-1px)';this.style.boxShadow='0 4px 12px rgba(77,121,255,0.3)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='none'">
              Refresh
            </button>
          </div>
        </div>
        
        <div id="locationsWrap" style="overflow-x:auto">
          <table style="width:100%;border-collapse:collapse">
            <thead>
              <tr style="background:#111">
                <th style="text-align:left;padding:16px;border-bottom:1px solid #333;color:#fff;font-weight:600;font-size:14px;text-transform:uppercase;letter-spacing:0.5px">User</th>
                <th style="text-align:left;padding:16px;border-bottom:1px solid #333;color:#fff;font-weight:600;font-size:14px;text-transform:uppercase;letter-spacing:0.5px">Email</th>
                <th style="text-align:left;padding:16px;border-bottom:1px solid #333;color:#fff;font-weight:600;font-size:14px;text-transform:uppercase;letter-spacing:0.5px">Coordinates</th>
                <th style="text-align:left;padding:16px;border-bottom:1px solid #333;color:#fff;font-weight:600;font-size:14px;text-transform:uppercase;letter-spacing:0.5px">Shared</th>
                <th style="text-align:left;padding:16px;border-bottom:1px solid #333;color:#fff;font-weight:600;font-size:14px;text-transform:uppercase;letter-spacing:0.5px">Actions</th>
              </tr>
            </thead>
            <tbody id="locationsBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <!-- Add user modal -->
  <div id="modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);align-items:center;justify-content:center;z-index:1000;backdrop-filter:blur(4px)">
    <div style="background:linear-gradient(135deg, #0b0b0b 0%, #111 100%);border:1px solid #333;border-radius:16px;width:480px;max-width:90vw;padding:24px;box-shadow:0 20px 60px rgba(0,0,0,0.5)">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid #333">
        <div style="width:40px;height:40px;background:linear-gradient(135deg, #4d79ff, #6b8cff);border-radius:10px;display:flex;align-items:center;justify-content:center">
          <span style="font-size:18px;color:#fff">‚ûï</span>
        </div>
        <div>
          <h3 style="margin:0;font-size:18px;color:#fff;font-weight:600">Add New User</h3>
          <p style="margin:4px 0 0;color:#888;font-size:14px">Create a new user account</p>
        </div>
        <button id="closeModal" style="margin-left:auto;border:0;background:transparent;font-size:20px;cursor:pointer;color:#999;padding:4px;border-radius:4px;transition:all 0.2s" onmouseover="this.style.background='#333';this.style.color='#fff'" onmouseout="this.style.background='transparent';this.style.color='#999'">√ó</button>
      </div>
      <form id="addForm" class="stack" style="display:grid;gap:16px">
        <div>
          <label style="display:block;margin-bottom:6px;color:#fff;font-weight:500;font-size:14px">Full Name</label>
          <input name="name" placeholder="Enter full name" required style="width:100%;padding:12px;background:#1a1a1a;border:1px solid #333;border-radius:8px;color:#fff;font-size:14px;transition:border-color 0.2s" onfocus="this.style.borderColor='#4d79ff'" onblur="this.style.borderColor='#333'" />
        </div>
        <div>
          <label style="display:block;margin-bottom:6px;color:#fff;font-weight:500;font-size:14px">Email Address</label>
          <input name="email" type="email" placeholder="Enter email address" required style="width:100%;padding:12px;background:#1a1a1a;border:1px solid #333;border-radius:8px;color:#fff;font-size:14px;transition:border-color 0.2s" onfocus="this.style.borderColor='#4d79ff'" onblur="this.style.borderColor='#333'" />
        </div>
        <div>
          <label style="display:block;margin-bottom:6px;color:#fff;font-weight:500;font-size:14px">Phone Number</label>
          <input name="phone" placeholder="Enter phone number" style="width:100%;padding:12px;background:#1a1a1a;border:1px solid #333;border-radius:8px;color:#fff;font-size:14px;transition:border-color 0.2s" onfocus="this.style.borderColor='#4d79ff'" onblur="this.style.borderColor='#333'" />
        </div>
        <div>
          <label style="display:block;margin-bottom:6px;color:#fff;font-weight:500;font-size:14px">Password</label>
          <input name="password" type="password" placeholder="Enter password" required style="width:100%;padding:12px;background:#1a1a1a;border:1px solid #333;border-radius:8px;color:#fff;font-size:14px;transition:border-color 0.2s" onfocus="this.style.borderColor='#4d79ff'" onblur="this.style.borderColor='#333'" />
        </div>
        <div>
          <label style="display:block;margin-bottom:6px;color:#fff;font-weight:500;font-size:14px">Role</label>
          <select name="role" style="width:100%;padding:12px;background:#1a1a1a;border:1px solid #333;border-radius:8px;color:#fff;font-size:14px;transition:border-color 0.2s" onfocus="this.style.borderColor='#4d79ff'" onblur="this.style.borderColor='#333'">
          <option value="user">User</option>
          <option value="admin">Admin</option>
        </select>
        </div>
        <div style="display:flex;gap:12px;margin-top:8px">
          <button type="button" id="cancelAddUser" style="flex:1;padding:12px;background:transparent;border:1px solid #333;border-radius:8px;color:#999;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.2s" onmouseover="this.style.background='#333';this.style.color='#fff'" onmouseout="this.style.background='transparent';this.style.color='#999'">Cancel</button>
          <button type="submit" style="flex:1;padding:12px;background:linear-gradient(135deg, #4d79ff, #6b8cff);border:none;border-radius:8px;color:#fff;cursor:pointer;font-size:14px;font-weight:600;transition:all 0.2s" onmouseover="this.style.transform='translateY(-1px)';this.style.boxShadow='0 4px 12px rgba(77,121,255,0.3)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='none'">Create User</button>
        </div>
        <div id="err" style="color:#ff6b6b;font-size:14px;text-align:center;margin-top:8px"></div>
      </form>
    </div>
  </div>

  <!-- Manage visibility modal -->
  <div id="visibilityModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);align-items:center;justify-content:center;z-index:1000;backdrop-filter:blur(4px)">
    <div style="background:linear-gradient(135deg, #0b0b0b 0%, #111 100%);border:1px solid #333;border-radius:16px;width:700px;max-width:95vw;max-height:90vh;overflow-y:auto;padding:24px;box-shadow:0 20px 60px rgba(0,0,0,0.5)">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid #333">
        <div style="width:40px;height:40px;background:linear-gradient(135deg, #ff4d4d, #ff6b6b);border-radius:10px;display:flex;align-items:center;justify-content:center">
          <span style="font-size:18px;color:#fff">‚öôÔ∏è</span>
        </div>
        <div>
          <h3 style="margin:0;font-size:18px;color:#fff;font-weight:600">Manage User Visibility</h3>
          <p style="margin:4px 0 0;color:#888;font-size:14px">Set region and country access permissions</p>
        </div>
        <button id="closeVisibilityModal" style="margin-left:auto;border:0;background:transparent;font-size:20px;cursor:pointer;color:#999;padding:4px;border-radius:4px;transition:all 0.2s" onmouseover="this.style.background='#333';this.style.color='#fff'" onmouseout="this.style.background='transparent';this.style.color='#999'">√ó</button>
      </div>
      
      <div id="userInfo" style="margin-bottom:24px;padding:16px;background:linear-gradient(135deg, #1a1a1a 0%, #222 100%);border-radius:12px;border:1px solid #333">
        <div style="display:flex;align-items:center;gap:12px">
          <div style="width:48px;height:48px;background:linear-gradient(135deg, #4d79ff, #6b8cff);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:700;color:#fff">
            <span id="userInitial">U</span>
          </div>
          <div>
            <div style="font-weight:600;margin-bottom:4px;color:#fff;font-size:16px" id="userName">User Name</div>
            <div style="color:#888;font-size:14px" id="userEmail">user@example.com</div>
          </div>
        </div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-bottom:24px">
        <!-- Countries Section -->
        <div>
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
            <div style="width:32px;height:32px;background:linear-gradient(135deg, #4d79ff, #6b8cff);border-radius:8px;display:flex;align-items:center;justify-content:center">
              <span style="font-size:14px;color:#fff">üåç</span>
            </div>
            <h3 style="margin:0;font-size:16px;color:#fff;font-weight:600">Countries</h3>
          </div>
          <div style="max-height:300px;overflow-y:auto;border:1px solid #333;border-radius:12px;padding:12px;background:#1a1a1a">
            <div id="countriesList"></div>
          </div>
        </div>

        <!-- Regions Section -->
        <div>
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
            <div style="width:32px;height:32px;background:linear-gradient(135deg, #ff4d4d, #ff6b6b);border-radius:8px;display:flex;align-items:center;justify-content:center">
              <span style="font-size:14px;color:#fff">üìç</span>
            </div>
            <h3 style="margin:0;font-size:16px;color:#fff;font-weight:600">Regions</h3>
          </div>
          <div style="max-height:300px;overflow-y:auto;border:1px solid #333;border-radius:12px;padding:12px;background:#1a1a1a">
            <div id="regionsList"></div>
          </div>
        </div>
      </div>

      <div style="display:flex;gap:12px;justify-content:flex-end;padding-top:16px;border-top:1px solid #333">
        <button id="cancelVisibility" style="padding:12px 20px;background:transparent;border:1px solid #333;border-radius:8px;color:#999;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.2s" onmouseover="this.style.background='#333';this.style.color='#fff'" onmouseout="this.style.background='transparent';this.style.color='#999'">Cancel</button>
        <button id="saveVisibility" style="padding:12px 20px;background:linear-gradient(135deg, #ff4d4d, #ff6b6b);border:none;border-radius:8px;color:#fff;cursor:pointer;font-size:14px;font-weight:600;transition:all 0.2s" onmouseover="this.style.transform='translateY(-1px)';this.style.boxShadow='0 4px 12px rgba(255,77,77,0.3)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='none'">Save Changes</button>
      </div>
      
      <div id="visibilityErr" style="color:#ff6b6b;font-size:14px;text-align:center;margin-top:12px"></div>
    </div>
  </div>

  <!-- Messaging Modal -->
  <div id="messagingModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);align-items:center;justify-content:center;z-index:1000;backdrop-filter:blur(4px)">
    <div style="background:linear-gradient(135deg, #0b0b0b 0%, #111 100%);border:1px solid #333;border-radius:16px;width:800px;max-width:95vw;height:600px;max-height:90vh;display:flex;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,0.5)">
      <!-- Chat Header -->
      <div id="chatHeader" style="display:flex;align-items:center;gap:12px;padding:16px 20px;border-bottom:1px solid #333;background:linear-gradient(135deg, #1a1a1a 0%, #222 100%);border-radius:16px 16px 0 0">
        <div id="chatAvatar" style="width:40px;height:40px;background:linear-gradient(135deg, #00d4aa, #00b894);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:600;color:#fff">U</div>
        <div style="flex:1">
          <div id="chatName" style="color:#fff;font-weight:600;font-size:16px">User Name</div>
          <div id="chatStatus" style="color:#888;font-size:12px">Online</div>
        </div>
        <div id="typingIndicator" style="color:#888;font-size:12px;display:none">typing...</div>
        <button id="closeMessagingModal" style="border:0;background:transparent;font-size:20px;cursor:pointer;color:#999;padding:4px;border-radius:4px;transition:all 0.2s" onmouseover="this.style.background='#333';this.style.color='#fff'" onmouseout="this.style.background='transparent';this.style.color='#999'">√ó</button>
      </div>
      
      <!-- Messages List -->
      <div id="messagesList" style="flex:1;overflow-y:auto;padding:16px;background:#111">
        <!-- Messages will be loaded here -->
      </div>
      
      <!-- Message Input -->
      <div id="messageInput" style="padding:16px 20px;background:#1a1a1a;border-top:1px solid #333;border-radius:0 0 16px 16px">
        <div style="display:flex;gap:8px;align-items:flex-end">
          <div style="flex:1">
            <textarea id="messageText" placeholder="Type your message..." style="width:100%;min-height:40px;max-height:120px;padding:8px 12px;background:#222;border:1px solid #444;border-radius:20px;color:#fff;resize:none;font-family:inherit;font-size:14px;outline:none" rows="1"></textarea>
          </div>
          <button id="sendMessageBtn" style="width:40px;height:40px;background:linear-gradient(135deg, #4d79ff, #6b8cff);border:none;border-radius:50%;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px" disabled>
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="22" y1="2" x2="11" y2="13"></line>
              <polygon points="22,2 15,22 11,13 2,9 22,2"></polygon>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // Fallback loading message
    document.addEventListener('DOMContentLoaded', function() {
      const tbody = document.getElementById('usersBody');
      if (tbody && tbody.innerHTML.trim() === '') {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" style="padding:40px;text-align:center;color:#888;font-style:italic">
              Loading users... If this message persists, check the browser console for errors.
            </td>
          </tr>
        `;
      }
    });
  </script>
  <script src="/admin-users.js?v=9"></script>
  
  <!-- Notification System -->
  <div id="notificationContainer" style="
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 10000;
    display: flex;
    flex-direction: column;
    gap: 10px;
  "></div>
</body>
</html>